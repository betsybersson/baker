{
    "contents" : "rm(list=ls())\nlibrary(lubridate)\nlibrary(sets)\nlibrary(R2WinBUGS)\nlibrary(gplots)\nlibrary(RColorBrewer)\nlibrary(binom)\nlibrary(coda)\nlibrary(nplcm)\n\nnewALLSITES           <- c(\"01KEN\",\"02GAM\",\"03MAL\",\"04ZAM\",\"05SAF\",\"THA\",\"BAN\")\ncurrent_study_site    <- 3\nsitename              <- newALLSITES[current_study_site]\nRawMeasDir            <- \"/Users/zhenkewu/Documents/BUGS/package_test/PQ_02OCT14.csv\"\n\npathogen10new <- c(\"HINF\", \"SASP\", \"SAUR\",# all bacteria up to now\n                   \"ADENO\",\"COR_43\", \"FLU_C\",\n                   \"HMPV_A_B\", \"PARA_1\",\"RHINO\",\"RSV\")\n\npathogen27new   <- c(\"HINF\",\"MCAT\",\"PNEU_N\",\"SASP\",\"SAUR\",#with BCX measures.\n                     \"BOPE\",\"C_PNEU\",\"M_PNEU\",\n                     \"PCP\",# up to now, all are bacteria or fungus.\n                     \"ADENO\",\"CMV\",\"COR_229\",\"COR_43\",\"COR_63\",\"COR_HKU\",\n                     \"FLU_C\",\"HBOV\",\"HMPV_A_B\",\n                     \"FLU_A\",\"FLU_B\",\n                     \"PARA_1\",\"PARA_2\",\"PARA_3\",\"PARA_4\",\n                     \"PV_EV\",\"RHINO\",\"RSV\")\n\nPathogen_anyorder   <- pathogen10new\n\n## output cleaned PERCH data:\nperch_data_clean_options <- list (case_def           =  \"CXRFINCAT_5\",\n                                  case_def_val       =  1,\n                                  X_strat            = c(\"newSITE\"),\n                                  X_strat_val        =  list(sitename),\n                                  Pathogen           =  Pathogen_anyorder,\n                                  extra_X            = c(\"ENRLDATE\",\"patid\",\"AGECAT\",\"HIV\"),#covariates besides case/control, and site\n                                  RawMeasDir         = RawMeasDir,\n                                  newSite_write_Dir  = \"/Users/zhenkewu/Documents/BUGS/package_test/PERCH_data_with_newSITE.csv\",\n                                  MeasDir            = \"/Users/zhenkewu/Documents/BUGS/package_test/PERCH_data_with_newSITE.csv\",\n                                  PathCatDir         = \"/Users/zhenkewu/Documents/BUGS/package_test/pathogen_category.csv\")\ncleaned_data  <- perch_data_clean(perch_data_clean_options)\n\n## output specific data sets to be used in Bayesian fitting:\nMobs  <- cleaned_data$Mobs\nY  <- cleaned_data$Y\nX  <- cleaned_data$X\nPathogen_cat <- cleaned_data$Pathogen_cat\nJSS <- cleaned_data$JSS\nPathogen     <- cleaned_data$Pathogen_MSS_ordered\n\n## BEGIN exploratory data analysis----------------------------------------------\neda_options <- list(             X_names     = list(\"site\"),\n                                 X_values    = list(sitename),# for plotting title on top of the figure.\n                                 total_positives = TRUE,\n                                 bubble_plot  = TRUE)\n## END exploratory data analysis----------------------------------------------\n\n\n\n## BEGIN preparation of data for nplcm_fit function-------------------\n# to add: 1.stratifying functionality, not regression; 2. borrow TPR information\n#         across the same category of pathogens\n#       model_options1 <- list(M_use = c(\"BrS\"), # has to be a subset of non-NA entries in Mobs.\n#                             k_subclass = 1,\n#                             TPR_prior  = c(\"noninformative\"),#same length as M_use.\n#                             Eti_prior  = \"overall_uniform\",\n#                             allowed_list  = Pathogen,\n#                             pathogen_list = Pathogen,\n#                             FPR_regression = NULL,\n#                             Eti_regression = NULL,\n#                             pathogen_cat = Pathogen_cat)\n#\n#       model_options2 <- list(M_use = c(\"BrS\",\"SS\"), # has to be a subset of non-NA entries in Mobs.\n#                              k_subclass = 1,\n#                              TPR_prior  = c(\"noninformative\",\"noninformative\"),#same length as M_use.\n#                              Eti_prior  = \"overall_uniform\",\n#                              allowed_list  = Pathogen,\n#                              pathogen_list = Pathogen,\n#                              FPR_regression = NULL,\n#                              Eti_regression = NULL,\n#                              pathogen_cat = Pathogen_cat)\n#\n#       model_options3 <- list(M_use = c(\"BrS\"), # has to be a subset of non-NA entries in Mobs.\n#                              k_subclass = 2,\n#                              TPR_prior  = c(\"noninformative\"),#same length as M_use.\n#                              Eti_prior  = \"overall_uniform\",\n#                              allowed_list  = Pathogen,\n#                              pathogen_list = Pathogen,\n#                              FPR_regression = NULL,\n#                              Eti_regression = NULL,\n#                              pathogen_cat = Pathogen_cat)\n#\n#       model_options4 <- list(M_use = c(\"BrS\",\"SS\"), # has to be a subset of non-NA entries in Mobs.\n#                              k_subclass = 2,\n#                              TPR_prior  = c(\"noninformative\",\"noninformative\"),#same length as M_use.\n#                              Eti_prior  = \"overall_uniform\",\n#                              allowed_list  = Pathogen,\n#                              pathogen_list = Pathogen,\n#                              FPR_regression = NULL,\n#                              Eti_regression = NULL,\n#                              pathogen_cat = Pathogen_cat)\n\nmodel_options5 <- list(M_use = c(\"BrS\",\"SS\"), # has to be a subset of non-NA entries in Mobs.\n                       k_subclass = 5,\n                       TPR_prior  = c(\"informative\",\"informative\"),#same length as M_use.\n                       Eti_prior  = \"overall_uniform\",\n                       allowed_list  = Pathogen,\n                       pathogen_list = Pathogen,\n                       FPR_regression = NULL,\n                       Eti_regression = NULL,\n                       pathogen_cat = Pathogen_cat)\n\nmodel_options6 <- list(M_use = c(\"BrS\",\"SS\"), # has to be a subset of non-NA entries in Mobs.\n                       k_subclass = 1,\n                       TPR_prior  = c(\"informative\",\"informative\"),#same length as M_use.\n                       Eti_prior  = \"overall_uniform\",\n                       allowed_list  = Pathogen,\n                       pathogen_list = Pathogen,\n                       FPR_regression = NULL,\n                       Eti_regression = NULL,\n                       pathogen_cat = Pathogen_cat)\n\nDate = gsub(\"-\", \"_\", Sys.Date())\n\nfname    <- paste0(\"/Users/zhenkewu/Documents/BUGS/\",Date,\"_\",sitename)\ndir.create(fname)\nfullname <- fname\n\n## for finer scenarios\nresult.folder <- fullname\ndir.create(result.folder)\n\n\nbugs.model.dir <- \"/Users/zhenkewu/Documents/BUGS/winbugs_model_package/\"\nwinbugs.dir    <- \"/Users/zhenkewu/.wine/drive_c/Program\\ Files/WinBUGS14\"\nWINE           <- \"/opt/local/bin/wine\"\nWINEPATH       <- \"/opt/local/bin/winepath\"\n\nmcmc_options <- list(debugstatus = !TRUE,\n                     n.chains   = 1,\n                     n.itermcmc = 20,#30000,\n                     n.burnin   = 0,#10000,\n                     n.thin     = 1,#20,\n                     individual.pred = TRUE,\n                     ppd    = !TRUE,\n                     result.folder = result.folder,\n                     bugsmodel.dir = bugs.model.dir,\n                     winbugs.dir   = winbugs.dir,\n                     WINE = WINE,\n                     WINEPATH = WINEPATH)\n## END preparation of data for nplcm_fit function---------------------\n\nmodel_options <- model_options5\n\n## BEGIN recording settings of current analysis-----------------------------------\ncat(\"Results stored in: \", result.folder,\"\\n\")\n#data clean options:\ndput(perch_data_clean_options,paste0(mcmc_options$result.folder,\n                                     \"/data_clean_options.txt\"))\n#model_options:\ndput(model_options,paste0(mcmc_options$result.folder,\"/model_options.txt\"))\n#mcmc_options:\ndput(mcmc_options,paste0(mcmc_options$result.folder,\"/mcmc_options.txt\"))\n\n#correlation structure:\npdf(paste0(mcmc_options$result.folder,\"/logOR_bubble_plot.pdf\"),height=20, width=20)\neda(Mobs, Y, X, eda_options,Pathogen)\ndev.off()\n## END recording settings of current analysis--------------------------------------\n\n## WinBUGS fitting\ngs <- nplcm_fit(Mobs,Y,X,model_options,mcmc_options)\n\n# DN: 1.check simulation study compatibility\n#     2.posterior-predictive checking procedure\n#      separate: marginal, pairwise associations\n#      combined:\n\n## BEGIN results visualization ------------------------------------------------\n## plot 1: three-panel plot:\npdf(paste0(result.folder,\"/\",sitename,\"_three_panel_plot.pdf\"),width=11,height=10)\nnplcm_plot_three_panel(DIR_NPLCM = result.folder,ss_upperlimit = .3,eti_upperlimit = .5)\ndev.off()\n\n## plot 2: individual diagnosis plot:\npdf(paste0(result.folder,\"/\",sitename,\"_individual_diagnosis.pdf\"),width=16,height=16)\npar(mfrow=c(4,4))\nnplcm_plot_individual_diagnosis(DIR_NPLCM=result.folder,npat=16)\ndev.off()\n## END of results visualization -----------------------------------------------\n\n## save workspace for future replot:\nsave.image(paste0(result.folder,\"/for_replot.RDATA\"))\n\n\n\n\n",
    "created" : 1412997868049.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3709171738",
    "id" : "14F7E2BA",
    "lastKnownWriteTime" : 1413002777,
    "path" : "~/Documents/BUGS/package_test/package_test_universal_mac.R",
    "project_path" : null,
    "properties" : {
        "tempName" : "Untitled1"
    },
    "source_on_save" : false,
    "type" : "r_source"
}